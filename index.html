<!DOCTYPE html>
<html>
  <head>
    <style>
      #canvas {
        width: 800px;
        height: 200px;
        border: 1px solid black;
      }
      #task-list {
        margin-top: 10px;
      }
      .highlight {
        border: 2px solid red;
      }
    </style>
  </head>
  <body>
    <h1>Todo List Tower Defense Game v1</h1>
    <form id="task-form">
      <input type="text" id="task-input" placeholder="Enter task" required />
      <input
        type="datetime-local"
        id="deadline-input"
        required
        max="${getTodayDateTime()}"
      />
      <button type="submit">Add Task</button>
    </form>
    <canvas id="canvas"></canvas>
    <ul id="task-list"></ul>

    <script>
      function getTodayDateTime() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, "0");
        const day = String(now.getDate()).padStart(2, "0");
        const hours = "00";
        const minutes = "00";
        return `${year}-${month}-${day}T${hours}:${minutes}`;
      }

      class Task {
        constructor(name, deadline) {
          this.name = name;
          this.deadline = new Date(deadline);
        }
      }

      class Baddy {
        constructor(task) {
          this.task = task;
          this.x = 0;
          this.y = canvas.height - 5; // Initial position at the bottom
          this.width = 5; // Fixed width of 10 pixels
          this.height = 5;
          this.startTime = Date.now();
          this.duration = task.deadline - this.startTime;
          this.distanceX = tower.x - this.x; // Calculate the distance to the tower
          this.speed = this.distanceX / this.duration / 1100; // Calculate the required speed in pixels

          this.setPosition = this.setPosition.bind(this);
          this.move = this.move.bind(this);
          this.draw = this.draw.bind(this);
        }

        setPosition(x, y) {
          this.x = x;
          this.y = y;
        }

        move() {
          const currentTime = Date.now();
          const elapsedTime = currentTime - this.startTime;

          if (elapsedTime <= this.duration) {
            const newX = Math.min(this.x + this.speed * elapsedTime, tower.x);
            this.setPosition(newX, this.y);
          }
        }

        draw() {
          ctx.fillStyle = "red";
          ctx.fillRect(this.x, this.y, this.width, this.height);
        }
      }

      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");
      const tower = {
        x: canvas.width - 40,
        y: canvas.height - 40, // Adjusted to touch the bottom
        width: 20,
        height: 40
      };

      const tasks = [];
      const baddies = [];

      const taskList = document.getElementById("task-list");
      const taskForm = document.getElementById("task-form");

      taskForm.addEventListener("submit", handleTaskSubmit);
      canvas.addEventListener("click", handleCanvasClick);

      function handleTaskSubmit(e) {
        e.preventDefault();
        const taskInput = document.getElementById("task-input");
        const deadlineInput = document.getElementById("deadline-input");
        const newTask = new Task(taskInput.value, deadlineInput.value);
        tasks.push(newTask);
        const newBaddy = new Baddy(newTask);
        baddies.push(newBaddy);

        renderGame();
      }

      function removeTask(index) {
        tasks.splice(index, 1);
        baddies.splice(index, 1); // Remove the associated baddy
        renderGame();
      }

      function renderTasks() {
        taskList.innerHTML = "";

        tasks.forEach((task, index) => {
          const li = document.createElement("li");
          const btn = document.createElement("button");
          btn.textContent = "Delete";
          btn.addEventListener("click", () => removeTask(index));

          const timeDifference = task.deadline - Date.now();
          const timeRemaining = Math.max(0, Math.ceil(timeDifference / 1000));

          li.textContent = `Task: ${
            task.name
          } - Deadline: ${task.deadline.toLocaleString()} - Time Remaining: ${timeRemaining} seconds`;
          li.appendChild(btn);
          taskList.appendChild(li);
        });
      }

      function moveBaddies() {
        baddies.forEach((baddy) => {
          baddy.move();
        });
      }

      function drawBaddies() {
        baddies.forEach((baddy) => {
          baddy.draw();
        });
      }

      function renderGame() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Render tower
        ctx.fillStyle = "blue";
        ctx.fillRect(tower.x, tower.y, tower.width, tower.height);

        moveBaddies(); // Move the baddies
        drawBaddies(); // Draw the baddies

        renderTasks();

        requestAnimationFrame(renderGame);
      }

      document.addEventListener("DOMContentLoaded", () => {
        renderGame();
      });
    </script>
  </body>
</html>
